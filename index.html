<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Science-Based Smart Cookbook</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script defer src="script.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script defer src="load-recipes.js"></script>
</head>
<body x-data="cookbookApp()" @init="init()">
  <main>
    <header>
      <div class="flex justify-between items-center">
        <h1>üß™ Science-Based Smart Cookbook</h1>
      </div>
      <div class="flex flex-wrap gap-3">
        <label class="flex items-center gap-2" for="recipe-select">
          <span>Recipe</span>
          <select id="recipe-select" x-model="selectedId" @change="loadRecipe()">
            <template x-for="r in recipes" :key="r.id">
              <option :value="r.id" x-text="r.meta.name"></option>
            </template>
          </select>
        </label>
        <button type="button" @click="deleteCurrentRecipe()" class="btn-danger">üóëÔ∏è Delete</button>
        <button type="button" @click="downloadBackup()" x-show="hasUnsavedChanges" class="btn-warning">‚¨áÔ∏è Backup All</button>
        <div class="flex items-center gap-2">
          <label for="servings-slider">Servings</label>
          <input type="range" id="servings-slider" min="1" max="200" step="1" class="w-40" x-model.number="servings" @input="adjustServings()" @change="adjustServings()" />
          <span class="w-12 text-right font-bold" x-text="servings"></span>
          <button type="button" class="btn-secondary text-xs" @click="resetServings()" :title="`Reset to base (${current.meta.base_servings})`">‚óè</button>
        </div>
        <label class="flex items-center gap-2">
          <input type="checkbox" id="ww-mode" x-model="wwMode" />
          <span for="ww-mode">Weight-conscious</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" id="veg-mode" x-model="vegMode" />
          <span for="veg-mode">Vegetarian</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" id="precision-mode" x-model="precisionMode" checked />
          <span for="precision-mode">Precision</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" id="science-mode" x-model="scienceMode" />
          <span for="science-mode">Show Science</span>
        </label>
      </div>
      <div class="mt-2">
        <button type="button" id="load-recipes-btn" class="btn-primary text-sm">üì• Load All Recipes</button>
        <span id="load-recipes-status" class="ml-2 text-xs"></span>
      </div>
    </header>

    <article>
      <div>
        <div>
          <p class="text-sm text-slate-300" x-text="current.meta.source"></p>
          <h2 class="text-xl" x-text="current.meta.name"></h2>
          <div class="flex flex-wrap gap-2 mt-1 text-sm text-emerald-300">
            <template x-if="stepSignals.temp">
              <span class="badge">Preheat: <span x-text="stepSignals.temp.value"></span>¬∞<span x-text="stepSignals.temp.unit"></span></span>
            </template>
            <template x-if="stepSignals.timeMinutes">
              <span class="badge">Time hint: <span x-text="formatMinutesFriendly(stepSignals.timeMinutes)"></span></span>
            </template>
          </div>
        </div>
        <div class="flex gap-2">
          <button type="button" @click="copyRecipe()">üìã Copy Recipe</button>
          <button type="button" @click="copyAIPrompt()">Ask AI</button>
        </div>
      </div>

      <!-- DEBUG PANEL (show only with ?debug=true) -->
      <div x-show="debugMode" class="debug-panel">
        <div><strong>DEBUG MODE ENABLED</strong> (use ?debug=false to hide)</div>
        <hr class="debug-divider">
        <div><strong>STATE:</strong></div>
        <div>selectedId = <span x-text="selectedId"></span></div>
        <div>recipes.length = <span x-text="recipes.length"></span></div>
        <div>current.meta.name = <span x-text="current.meta?.name"></span></div>
        <div>current.ingredients.length = <span x-text="current.ingredients?.length"></span></div>
        <div>current.steps.length = <span x-text="current.steps?.length"></span></div>
        <div>servings = <span x-text="servings"></span></div>
        <hr class="debug-divider">
        <div><strong>COMPUTED:</strong></div>
        <div>displayIngredients().length = <span x-text="displayIngredients().length"></span></div>
        <div>stepsList().length = <span x-text="stepsList().length"></span></div>
        <div>nutritionLoaded = <span x-text="nutritionLoaded"></span></div>
        <div>nutritionError = <span x-text="nutritionError"></span></div>
        <hr class="debug-divider">
        <div><strong>PREFS:</strong></div>
        <div>weightUnit = <span x-text="prefs.weightUnit"></span></div>
        <div>volumeUnit = <span x-text="prefs.volumeUnit"></span></div>
        <div>tempUnit = <span x-text="prefs.tempUnit"></span></div>
      </div>

      <div class="grid-2col">
        <section>
          <h3 class="font-bold mb-2">Ingredients</h3>
          <ul class="space-y-2">
            <template x-for="ing in displayIngredients()" :key="ing.name">
                <li class="ingredient" :class="ing.swapped && 'swapped'" :title="ing.nutritionTooltip">
                <div>
                  <span class="quantity" x-text="formatQuantity(ing)"></span>
                  <span x-text="ing.displayName"></span>
                  <span class="function" x-show="scienceMode && ing.function" x-text="'(' + ing.function + ')' "></span>
                  <span class="suggestion-wrap" :style="ing.suggestion ? '' : 'display: none'">
                    <button
                      type="button"
                      class="suggestion-icon"
                      :aria-label="ing.suggestion ? 'Suggestion: ' + ing.suggestion.text : ''"
                      x-text="ing.suggestion?.icon || ''"
                    ></button>
                    <span class="suggestion-tooltip" x-text="ing.suggestion?.text || ''"></span>
                  </span>
                </div>
                  <span class="science-note" x-show="ing.swapped" x-text="ing.science_note"></span>
                </li>
            </template>
          </ul>
        </section>
        <section>
          <h3 class="font-bold mb-2">Steps</h3>
          <ol class="list-decimal">
            <template x-for="(step, idx) in stepsList()" :key="idx">
              <li class="leading-relaxed" x-text="step"></li>
            </template>
          </ol>
        </section>

        <!-- Science Notes Section -->
        <section x-show="scienceMode && current.science_notes && current.science_notes.length" class="mt-4 bg-blue-900-20 border border-blue-700">
          <h3 class="font-bold mb-2 text-blue-400">üî¨ Cooking Science</h3>
          <ul class="space-y-2 text-sm">
            <template x-for="(note, idx) in (current.science_notes || [])" :key="idx">
              <li class="leading-relaxed">‚Ä¢ <span x-text="note"></span></li>
            </template>
          </ul>
        </section>
      </div>
    </article>

    <section>
      <div>
        <h2 class="text-lg">Nutrition</h2>
        <span class="text-xs text-red-300" x-show="nutritionError">Data unavailable (nutrition.yaml not found)</span>
        <span class="text-xs text-slate-400" x-show="!nutritionLoaded && !nutritionError">Loading nutrition‚Ä¶</span>
      </div>
      <div x-show="nutritionLoaded && !nutritionError" class="grid-2col text-sm">
        <div class="nutrition-col">
          <h3>Total (recipe)</h3>
          <p x-text="`${nutritionSummary().total.calories} kcal`"></p>
          <p x-text="`Protein: ${nutritionSummary().total.protein.toFixed(1)} g`"></p>
          <p x-text="`Fat: ${nutritionSummary().total.fat.toFixed(1)} g`"></p>
          <p x-text="`Carbs: ${nutritionSummary().total.carbs.toFixed(1)} g`"></p>
          <p x-text="`Fiber: ${nutritionSummary().total.fiber.toFixed(1)} g`"></p>
        </div>
        <div class="nutrition-col">
          <h3>Per serving</h3>
          <p x-text="`${nutritionSummary().per.calories} kcal`"></p>
          <p x-text="`Protein: ${nutritionSummary().per.protein.toFixed(1)} g`"></p>
          <p x-text="`Fat: ${nutritionSummary().per.fat.toFixed(1)} g`"></p>
          <p x-text="`Carbs: ${nutritionSummary().per.carbs.toFixed(1)} g`"></p>
          <p x-text="`Fiber: ${nutritionSummary().per.fiber.toFixed(1)} g`"></p>
        </div>
      </div>
    </section>

    <section>
      <div>
        <h2 class="text-lg">Bookmarklet</h2>
        <button type="button" @click="copyBookmarklet()">Copy Bookmarklet</button>
      </div>
      <p class="text-sm">Drag this link to your bookmarks bar or copy the code. Click it on recipe pages to copy YAML.</p>
      <a class="underline break-all text-emerald-300" :href="bookmarkletCode">Save to Cookbook</a>
      <label for="bookmarklet-code" class="sr-only">Bookmarklet code</label>
      <textarea id="bookmarklet-code" class="h-24 text-xs" x-model="bookmarkletCode" readonly></textarea>
    </section>

    <section>
      <h2 class="text-lg">YAML Import / Export</h2>
      <p class="text-sm">Paste a recipe YAML to load it, or click Save to dump the current recipe back to YAML.</p>
      <label for="yaml-input" class="sr-only">YAML recipe data</label>
      <textarea id="yaml-input" class="h-40 text-sm" x-model="yamlText" placeholder="Paste recipe YAML here..."></textarea>
      <div class="flex gap-3">
        <button type="button" @click="loadYaml()">Load YAML</button>
        <button type="button" class="secondary" @click="saveYaml()">Save Current to YAML</button>
        <button type="button" class="secondary" @click="loadORF()">Load ORF</button>
        <button type="button" class="secondary" @click="saveORF()">Save Current to ORF</button>
        <button type="button" class="secondary" @click="downloadAllAsZip()">üì¶ Download All (.zip)</button>
      </div>
    </section>

    <section>
      <h2 class="text-lg">Display Preferences</h2>
      <p class="text-sm">Choose how quantities and temperatures are shown.</p>
      <div class="grid-3col">
        <label class="flex flex-col gap-1" for="unit-system">
          <span class="font-medium">Unit system</span>
          <select id="unit-system" x-model="prefs.system" @change="setSystem(prefs.system)">
            <option value="auto">Best fit (region)</option>
            <option value="metric">Metric</option>
            <option value="imperial">Imperial</option>
          </select>
        </label>
        <label class="flex flex-col gap-1" for="weight-unit">
          <span class="font-medium">Weight</span>
          <select id="weight-unit" x-model="prefs.weightUnit" @change="persistPrefs()">
            <option value="g">Grams</option>
            <option value="oz">Ounces</option>
          </select>
        </label>
        <label class="flex flex-col gap-1" for="volume-unit">
          <span class="font-medium">Volume</span>
          <select id="volume-unit" x-model="prefs.volumeUnit" @change="persistPrefs()">
            <option value="cups">Cups/Tbsp/Tsp</option>
            <option value="ml">Milliliters</option>
          </select>
        </label>
        <label class="flex flex-col gap-1" for="temp-unit">
          <span class="font-medium">Temperature</span>
          <select id="temp-unit" x-model="prefs.tempUnit" @change="persistPrefs()">
            <option value="C">Celsius</option>
            <option value="F">Fahrenheit</option>
          </select>
        </label>
      </div>
    </section>

    <!-- Copyright & Open Culture Education Section -->
    <section>
      <div>
        <h2 class="text-lg">üìú Open Recipes & Copyright</h2>
        <button type="button" @click="showCopyright = !showCopyright">
          <span x-text="showCopyright ? 'Hide' : 'Learn'"></span>
        </button>
      </div>

      <div x-show="showCopyright" class="space-y-4 text-sm text-gray-200">
        <div class="copyright-box copyright-box-truth">
          <h3 class="text-emerald-400">üîë The Core Truth</h3>
          <p>Recipes are <strong>NOT copyrighted</strong> by law, and that's intentional. Ingredient lists and basic instructions are part of the public domain‚Äîfree for everyone to use, adapt, and share.</p>
        </div>

        <div class="copyright-box copyright-box-protected">
          <h3 class="text-blue-400">‚úÖ What IS Protected</h3>
          <ul class="list-disc list-inside space-y-1 text-xs">
            <li><strong>Photos & videos</strong> you create</li>
            <li><strong>Stories & descriptions</strong> (substantial literary expression)</li>
            <li><strong>Cookbook selection & arrangement</strong> (as a whole)</li>
            <li><strong>Your unique voice</strong> and creative presentation</li>
          </ul>
        </div>

        <div class="copyright-box copyright-box-remix">
          <h3 class="text-purple-400">ü§ù Remix Culture</h3>
          <p>Like open-source software, recipes thrive when shared, adapted, and improved. We encourage you to:</p>
          <ul class="list-disc list-inside space-y-1 text-xs mt-2">
            <li>Use any recipe as a starting point</li>
            <li>Adapt to your needs and preferences</li>
            <li>Share improvements with the community</li>
            <li>Credit sources (respectful, not required)</li>
          </ul>
        </div>

        <div class="copyright-box copyright-box-learn">
          <h3 class="text-orange-400">üìñ Learn More</h3>
          <p>Read our full guide: <a href="./COPYRIGHT.md" class="text-emerald-300">COPYRIGHT.md</a></p>
          <p class="text-xs mt-2 text-gray-400">Topics: copyright law, attribution, Creative Commons, open culture, how to share ethically</p>
        </div>

        <div class="text-xs text-gray-400 italic">
          <p>‚ú® This cookbook uses <strong>CC BY-SA 4.0 License</strong>: Share freely, credit sources, share improvements under same license.</p>
        </div>
      </div>
    </section>
  </main>
</body>
</html>
